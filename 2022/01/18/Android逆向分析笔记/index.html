<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CFira+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Apk分析流程：  GDA等工具查看加固、加壳信息 如果有壳，进行脱壳 GDA、jeb、jdax、apktool反编译查看，静态分析：关键字符串、关键api调用 如果静态分析无法定位，可能使用了字符串加密、反射调用等手段，动态分析：hook、动态调试 确定是java层还是jni再进一步分析  JVM类加载器（加载顺序如下）：  Bootstrap ClassLoader  引导类加载器，C&#x2F;C++">
<meta property="og:type" content="article">
<meta property="og:title" content="Android逆向分析笔记">
<meta property="og:url" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="尘埃落定的空间站">
<meta property="og:description" content="Apk分析流程：  GDA等工具查看加固、加壳信息 如果有壳，进行脱壳 GDA、jeb、jdax、apktool反编译查看，静态分析：关键字符串、关键api调用 如果静态分析无法定位，可能使用了字符串加密、反射调用等手段，动态分析：hook、动态调试 确定是java层还是jni再进一步分析  JVM类加载器（加载顺序如下）：  Bootstrap ClassLoader  引导类加载器，C&#x2F;C++">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220409193259595.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/20210108150835-53436af4-5180-1.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/7C694C34-1D7C-4E2A-9AB0-42F1827BC10D.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/852E76B9-9A39-42D7-869D-1705A797C001.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/F090258E-8BD3-4D7F-B67E-D3B4B32B4D8E.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/2DF19C19-8A3A-4537-AFAF-3BBC14E9E031.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/543C0438-FE56-4ED9-BE98-9AEAD5645A41.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/9D511DC3-3A12-4C89-9B7F-6F9FF4612D6E.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/activity_lifecycle.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220128112100992.png">
<meta property="og:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220128121435652.png">
<meta property="article:published_time" content="2022-01-18T14:43:56.000Z">
<meta property="article:modified_time" content="2022-04-30T15:33:24.662Z">
<meta property="article:author" content="尘埃落定">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220409193259595.png">


<link rel="canonical" href="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/","path":"2022/01/18/Android逆向分析笔记/","title":"Android逆向分析笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Android逆向分析笔记 | 尘埃落定的空间站</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">尘埃落定的空间站</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTPS%E6%8A%93%E5%8C%85"><span class="nav-number">1.</span> <span class="nav-text">HTTPS抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%AE%89%E5%8D%93%E5%88%86%E6%9E%90%E7%8E%AF%E5%A2%83"><span class="nav-number">2.</span> <span class="nav-text">搭建安卓分析环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E7%AC%AC%E4%B8%80%E4%B8%AAAndroid%E7%A8%8B%E5%BA%8F"><span class="nav-number">3.</span> <span class="nav-text">分析第一个Android程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Crackme0201%EF%BC%88sn%E7%A0%81%E6%B3%A8%E5%86%8C%EF%BC%89"><span class="nav-number">3.1.</span> <span class="nav-text">Crackme0201（sn码注册）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A0%B4%E8%A7%A3"><span class="nav-number">3.2.</span> <span class="nav-text">破解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dalvik%E6%A0%BC%E5%BC%8F%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">4.</span> <span class="nav-text">Dalvik格式与字节码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAvsJava%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">4.1.</span> <span class="nav-text">Dalvik虚拟机vsJava虚拟机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">虚拟机执行流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90Android%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.</span> <span class="nav-text">静态分析Android程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E5%BC%80%E5%8F%91%E5%B0%8F%E8%AE%B0"><span class="nav-number">6.</span> <span class="nav-text">Android开发小记</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B4%BB%E5%8A%A8%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">6.1.</span> <span class="nav-text">活动的生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android%E5%B8%83%E5%B1%80"><span class="nav-number">6.2.</span> <span class="nav-text">Android布局</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">尘埃落定</p>
  <div class="site-description" itemprop="description">Stay Hungry, Stay Foolish.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/leothompson2" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;leothompson2" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://unsplash.com/@leothompson" title="Unsplash → https:&#x2F;&#x2F;unsplash.com&#x2F;@leothompson" rel="noopener" target="_blank"><i class="fab fa-unsplash fa-fw"></i>Unsplash</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="尘埃落定">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="尘埃落定的空间站">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Android逆向分析笔记 | 尘埃落定的空间站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android逆向分析笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-18 22:43:56" itemprop="dateCreated datePublished" datetime="2022-01-18T22:43:56+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-04-30 23:33:24" itemprop="dateModified" datetime="2022-04-30T23:33:24+08:00">2022-04-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><strong>Apk分析流程：</strong></p>
<ol>
<li>GDA等工具查看加固、加壳信息</li>
<li>如果有壳，进行脱壳</li>
<li>GDA、jeb、jdax、apktool反编译查看，静态分析：关键字符串、关键api调用</li>
<li>如果静态分析无法定位，可能使用了字符串加密、反射调用等手段，动态分析：hook、动态调试</li>
<li>确定是java层还是jni再进一步分析</li>
</ol>
<p><strong>JVM类加载器（加载顺序如下）：</strong></p>
<ul>
<li>Bootstrap ClassLoader</li>
</ul>
<p>引导类加载器，C/C++代码实现的加载器，用于加载指定的JDK的核心库类，例如：java.lang、java.uti等系统类。Java虚拟机的启动就是通过Bootstrap，该Classloader无法在java里获取，负责加载/lib下的类。</p>
<ul>
<li>Extensions ClassLoader</li>
</ul>
<p>拓展类加载器，Java中实现类为ExtClassLoader，提供类除系统类之外的额外功能，可在java里获取，负责加载/lib/ext下的类。</p>
<ul>
<li>Application ClassLoader</li>
</ul>
<p>应用程序加载器，Java中实现类为AppClassLoader，开发人员写的代码默认由它来加载，ClassLoader.getSystemClassLoader返回的就是它。</p>
<p><strong>双亲委派模式：</strong></p>
<p>如果一个类加载器收到了类加载请求，会递归请求向父类的加载器去加载，依次进行委托，最终到达顶层的启动类加载器去执行。如果父类可以完成加载任务，成功返回，否则子加载器才会尝试加载。</p>
<p>why：</p>
<ol>
<li>避免重复加载，如果已经加载过一次Class，可以直接读取已经加载的Class</li>
<li>更加安全，无法自定义类替代系统的类，防止核心API库被随意篡改</li>
</ol>
<p>验证双亲委派：</p>
<p>如下可以知道当前ClassLoader为PathClassLoader，父类BootClassLoader，顶层为BootClassLoader</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClassLoader thisClassLoader = MainActivity.class.getClassLoader();</span><br><span class="line">    Log.i(<span class="string">&quot;kanxue&quot;</span>, <span class="string">&quot;testClassLoader: &quot;</span> + thisClassLoader);</span><br><span class="line">    ClassLoader tmpClassLoader = <span class="keyword">null</span>;</span><br><span class="line">    ClassLoader parentClassLoader = thisClassLoader.getParent();</span><br><span class="line">    <span class="keyword">while</span> (parentClassLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;kanxue&quot;</span>, <span class="string">&quot;this: &quot;</span> + thisClassLoader + <span class="string">&quot;---&quot;</span> + parentClassLoader);</span><br><span class="line">        tmpClassLoader = parentClassLoader.getParent();</span><br><span class="line">        thisClassLoader = parentClassLoader;</span><br><span class="line">        parentClassLoader = tmpClassLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.i(<span class="string">&quot;kanxue&quot;</span>, <span class="string">&quot;root: &quot;</span> + thisClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220409193259595.png" alt="image-20220409193259595"></p>
<p><strong><font color="red">类加载（此处学习p神知识星球相关内容）：</font></strong></p>
<ul>
<li>类加载的时机</li>
<li>JVM类加载流程</li>
</ul>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/20210108150835-53436af4-5180-1.png" alt="img"></p>
<p><strong>Android的类加载器：</strong></p>
<ul>
<li>ClassLoader为抽象类</li>
<li>BootClassLoader</li>
</ul>
<p>预加载常用类，单例模式。与Java中的BootClassLoader不同，它不是由C/C++代码实现，而是由Java实现。</p>
<ul>
<li><p>BaseDexClassLoader<br>类加载的主要逻辑在BaseDexClassLoader中完成，是<strong>PathClassLoader</strong>、<strong>DexClassLoader</strong>、<strong>InMemoryDexClassLoader</strong>的父类</p>
<ul>
<li>PathClassLoader：Android默认使用的类加载器，例如apk中的Activity便是在其中加载</li>
<li>DexClassLoader：可以加载任意目录下的dex/jar/apk/zip文件，比PathClassLoader更灵活，是实现插件化、热修复、<strong>dex加壳</strong>的重点</li>
<li>InMemoryDexclassLoader：Android8.0引入，可以从内存加载类</li>
</ul>
</li>
<li><p>SecureClassLoader</p>
</li>
</ul>
<p>继承了抽象类ClassLoader，拓展了ClassLoader类，加入了权限方面的功能，加强了安全性。其子类URLClassLoader使用URL路径从jar文件中加载类和资源。</p>
<p>使用DexClassLoader类实现一个简单的动态加载dex：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a &#123;<span class="doctag">@code</span> DexClassLoader&#125; that finds interpreted and native</span></span><br><span class="line"><span class="comment">    * code.  Interpreted classes are found in a set of DEX files contained</span></span><br><span class="line"><span class="comment">    * in Jar or APK files.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;The path lists are separated using the character specified by the</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> path.separator&#125; system property, which defaults to &#123;<span class="doctag">@code</span> :&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</span></span><br><span class="line"><span class="comment">    *     resources, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;, which</span></span><br><span class="line"><span class="comment">    *     defaults to &#123;<span class="doctag">@code</span> &quot;:&quot;&#125; on Android</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> optimizedDirectory directory where optimized dex files</span></span><br><span class="line"><span class="comment">    *     should be written; must not be &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> librarySearchPath the list of directories containing native</span></span><br><span class="line"><span class="comment">    *     libraries, delimited by &#123;<span class="doctag">@code</span> File.pathSeparator&#125;; may be</span></span><br><span class="line"><span class="comment">    *     &#123;<span class="doctag">@code</span> null&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> parent the parent class loader</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">        String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">new</span> File(optimizedDirectory), librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>源码相关：</p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/">http://androidxref.com/</a></p>
<h3 id="HTTPS抓包"><a href="#HTTPS抓包" class="headerlink" title="HTTPS抓包"></a>HTTPS抓包</h3><p>核心原理：抓取包处于明文状态的一切时机</p>
<p>抓包：</p>
<ul>
<li>HTTP框架hook</li>
<li>系统框架hook</li>
<li>中间人抓包</li>
</ul>
<p>工具：Charles、BurpSuite</p>
<p>HTTP缺陷：</p>
<ul>
<li>明文通信</li>
<li>没有身份校验</li>
<li>没有完整性校验</li>
</ul>
<h3 id="搭建安卓分析环境"><a href="#搭建安卓分析环境" class="headerlink" title="搭建安卓分析环境"></a>搭建安卓分析环境</h3><ul>
<li>macOS：首先进行Homebrew换源，<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/%E3%80%82%E5%BD%93%E5%89%8D%E5%B7%B2%E7%BB%8F%E9%9B%86%E6%88%90%E4%BA%86homebrew-cask%EF%BC%9Ahttps://www.zhihu.com/question/22624898">https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/。当前已经集成了homebrew-cask：https://www.zhihu.com/question/22624898</a></li>
<li><ul>
<li>JDK：从oracle官网安装，jdk1.8</li>
<li>Android Studio</li>
</ul>
</li>
<li>源码分析环境：使用docker，CLI+Docker Desktop</li>
<li>常见逆向分析工具：010Editor、small.jar、baksmali、dex2jar，工具可以从52盘里去先找找看</li>
</ul>
<h3 id="分析第一个Android程序"><a href="#分析第一个Android程序" class="headerlink" title="分析第一个Android程序"></a>分析第一个Android程序</h3><h4 id="Crackme0201（sn码注册）"><a href="#Crackme0201（sn码注册）" class="headerlink" title="Crackme0201（sn码注册）"></a>Crackme0201（sn码注册）</h4><p>gradle：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Gradle%EF%BC%8C%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE**%E8%87%AA%E5%8A%A8%E5%8C%96**%E7%9A%84%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7">https://zh.wikipedia.org/wiki/Gradle，一个项目**自动化**的构建工具</a></p>
<p>gradlew：<a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/gradle_wrapper.html">https://docs.gradle.org/current/userguide/gradle_wrapper.html</a></p>
<p>编译程序：菜单项目：Build-&gt;Make Project，输出如下</p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/7C694C34-1D7C-4E2A-9AB0-42F1827BC10D.png" alt="7C694C34-1D7C-4E2A-9AB0-42F1827BC10D"></p>
<h4 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h4><p>一般的流程：使用反编译工具对APK文件进行反编译，阅读生成的smali文件理解运行机制，修改smali并重新编译、签名，安装测试。</p>
<p>寻找突破点，这个案例中输入错误会给我们<strong>提示错误</strong>，一般来说，这种地方就是核心验证代码的地方。错误提示属于字符串资源，存放于res/values/strings.xml中，打包时被加密存储到resource.arsc文件中。strings.xml中<strong>字符串资源</strong>在/gen/R.java文件中的<strong>String类</strong>中进行标识，有唯一的int类型的索引值（反编译后保存在<strong>public.xml</strong>中）。</p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/852E76B9-9A39-42D7-869D-1705A797C001.png" alt="852E76B9-9A39-42D7-869D-1705A797C001"></p>
<p><font color="red">在生成的文件中有<strong>MainActivity.smal</strong>与<strong>MainActivity$1.smali?</strong></font></p>
<p>查看调用后，除了资源文件，只有<strong>MainActivity$1.smali</strong>文件中有调用，查看该文件关键调用</p>
<p>使用AndriodKiler，Windows环境</p>
<p>const v2, 0x7f0f0071位于函数checkSN()中，查看checkSN()函数</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">\# virtual methods</span><br><span class="line"></span><br><span class="line">.method public onClick(Landroid/view/View;)V</span><br><span class="line"></span><br><span class="line">.locals 3</span><br><span class="line"></span><br><span class="line">.param p1, &quot;view&quot; # Landroid/view/View;</span><br><span class="line"></span><br><span class="line">.line 41</span><br><span class="line"></span><br><span class="line">iget-object v0, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span><br><span class="line"></span><br><span class="line">invoke-static &#123;v0&#125;, Lcom/example/crackme0201/MainActivity;-&gt;access$000(Lcom/example/crackme0201/MainActivity;)Landroid/widget/EditText;</span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v1&#125;, Landroid/widget/EditText;-&gt;getText()Landroid/text/Editable;</span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v1&#125;, Ljava/lang/Object;-&gt;toString()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v1&#125;, Ljava/lang/String;-&gt;trim()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v1</span><br><span class="line"></span><br><span class="line">iget-object v2, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span><br><span class="line"></span><br><span class="line">invoke-static &#123;v2&#125;, Lcom/example/crackme0201/MainActivity;-&gt;access$100(Lcom/example/crackme0201/MainActivity;)Landroid/widget/EditText;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v2&#125;, Landroid/widget/EditText;-&gt;getText()Landroid/text/Editable;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v2&#125;, Ljava/lang/Object;-&gt;toString()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;v2&#125;, Ljava/lang/String;-&gt;trim()Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">move-result-object v2</span><br><span class="line"></span><br><span class="line">invoke-static &#123;v0, v1, v2&#125;, Lcom/example/crackme0201/MainActivity;-&gt;access$200(Lcom/example/crackme0201/MainActivity;Ljava/lang/String;Ljava/lang/String;)Z</span><br><span class="line"></span><br><span class="line">move-result v0</span><br><span class="line"></span><br><span class="line">const/4 v1, 0x0</span><br><span class="line"></span><br><span class="line">if-nez v0, :cond<span class="emphasis">_0</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">.line 42</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">iget-object v0, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">const v2, 0x7f0f0071</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-static &#123;v0, v2, v1&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;II)Landroid/widget/Toast;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">move-result-object v0</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">goto :goto_</span>0</span><br><span class="line"></span><br><span class="line">.line 45</span><br><span class="line"></span><br><span class="line">:cond<span class="emphasis">_0</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">iget-object v0, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">const v2, 0x7f0f006e</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-static &#123;v0, v2, v1&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;II)Landroid/widget/Toast;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">move-result-object v0</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">.line 46</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">iget-object v0, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-static &#123;v0&#125;, Lcom/example/crackme0201/MainActivity;-&gt;access$300(Lcom/example/crackme0201/MainActivity;)Landroid/widget/Button;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">move-result-object v0</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-virtual &#123;v0, v1&#125;, Landroid/widget/Button;-&gt;setEnabled(Z)V</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">.line 47</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">iget-object v0, p0, Lcom/example/crackme0201/MainActivity$1;-&gt;this$0:Lcom/example/crackme0201/MainActivity;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">const v1, 0x7f0f006a</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">invoke-virtual &#123;v0, v1&#125;, Lcom/example/crackme0201/MainActivity;-&gt;setTitle(I)V</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">.line 51</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">:goto_</span>0</span><br><span class="line"></span><br><span class="line">return-void</span><br><span class="line"></span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>





<h3 id="Dalvik格式与字节码"><a href="#Dalvik格式与字节码" class="headerlink" title="Dalvik格式与字节码"></a>Dalvik格式与字节码</h3><p>Dalvik是Android平台用于运行Android程序的虚拟机，<strong>Android4.4</strong>版本之前。</p>
<ul>
<li>常量池采用32位索引，对类方法名、字段名、常量的寻址速度快</li>
<li>寄存器架构，完整的指令系统，对象生命周期管理、堆栈管理、线程管理…</li>
<li>所有的Android程序运行在Android系统进程中，每个进程与一个Dalvik虚拟机实例对应</li>
</ul>
<h4 id="Dalvik虚拟机vsJava虚拟机"><a href="#Dalvik虚拟机vsJava虚拟机" class="headerlink" title="Dalvik虚拟机vsJava虚拟机"></a>Dalvik虚拟机vsJava虚拟机</h4><table>
<thead>
<tr>
<th></th>
<th><strong>Dalvik VM</strong></th>
<th><strong>Java VM</strong></th>
<th><strong>Comments</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>字节码</strong></td>
<td>class文件</td>
<td>Dex文件（由java字节码转化而来，由dx工具完成）</td>
<td></td>
</tr>
<tr>
<td><strong>体积</strong></td>
<td>相对大</td>
<td>相对小</td>
<td>dx将class文件中的冗余信息消除，对class文件进行了重排列。相同的字符串和常量在dex中只会出现一次；jar文件中，如果class文件引用了其他class文件中的方法，签名会被复制，造成文件体积增大。 例如，如果在不同的类文件中找到相同的String，则.dex文件仅包含此String的一个引用。</td>
</tr>
<tr>
<td><strong>虚拟机架构</strong></td>
<td>栈架构</td>
<td>寄存器架构，数据访问直接在寄存器之间传递</td>
<td></td>
</tr>
</tbody></table>
<p>如下代码，进行Java字节码与Dalvik字节码对比</p>
<p>Java字节码：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java%E5%AD%97%E8%8A%82%E7%A0%81">https://zh.wikipedia.org/wiki/Java%E5%AD%97%E8%8A%82%E7%A0%81</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">return</span> (a + b) * (a - b);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     Hello hello = <span class="keyword">new</span> Hello();</span><br><span class="line"></span><br><span class="line">	   System.out.println(hello.foo(<span class="number">5</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用javap进行反汇编</strong></p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/F090258E-8BD3-4D7F-B67E-D3B4B32B4D8E.png" alt="F090258E-8BD3-4D7F-B67E-D3B4B32B4D8E"></p>
<p><strong>$ javap -c -classpath . Hello</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Compiled from <span class="string">&quot;Hello.java&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  Code:</span><br><span class="line"></span><br><span class="line">​    <span class="number">0</span>: aload_0</span><br><span class="line"></span><br><span class="line">​    <span class="number">1</span>: invokespecial #<span class="number">1</span>         <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"></span><br><span class="line">​    <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"> **<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;**</span><br><span class="line"></span><br><span class="line">  **Code:**</span><br><span class="line"></span><br><span class="line">**<span class="comment">//这里0为偏移量，iload_1表示将int类型的第“1”（参数从0开始）load（入栈），jvm虚拟机运行时涉及PC计数器（当前位置与方法开头位置的偏移量）、局部变量、“求值栈”（指令中的参数通过此栈来传递，frame）**</span></span><br><span class="line"></span><br><span class="line">​    **<span class="number">0</span>: iload_1**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">1</span>: iload_2**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">2</span>: iadd**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">3</span>: iload_1**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">4</span>: iload_2**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">5</span>: isub**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">6</span>: imul**</span><br><span class="line"></span><br><span class="line">​    **<span class="number">7</span>: ireturn**</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line"></span><br><span class="line">  Code:</span><br><span class="line"></span><br><span class="line">​    <span class="number">0</span>: <span class="keyword">new</span>      #<span class="number">2</span>         <span class="comment">// class Hello</span></span><br><span class="line"></span><br><span class="line">​    <span class="number">3</span>: dup</span><br><span class="line"></span><br><span class="line">​    <span class="number">4</span>: invokespecial #<span class="number">3</span>         <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"></span><br><span class="line">​    <span class="number">7</span>: astore_1</span><br><span class="line"></span><br><span class="line">​    <span class="number">8</span>: getstatic   #<span class="number">4</span>         <span class="comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line"></span><br><span class="line">   <span class="number">11</span>: aload_1</span><br><span class="line"></span><br><span class="line">   <span class="number">12</span>: iconst_5</span><br><span class="line"></span><br><span class="line">   <span class="number">13</span>: iconst_3</span><br><span class="line"></span><br><span class="line">   <span class="number">14</span>: invokevirtual #<span class="number">5</span>         <span class="comment">// Method foo:(II)I</span></span><br><span class="line"></span><br><span class="line">   <span class="number">17</span>: invokevirtual #<span class="number">6</span>         <span class="comment">// Method java/io/PrintStream.println:(I)V</span></span><br><span class="line"></span><br><span class="line">   <span class="number">20</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用dexdump对dex文件进行反汇编</strong></p>
<p><strong>$ ~/Library/Android/sdk/build-tools/30.0.2/dexdump -d Hello.dex</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Processing &#x27;Hello.dex&#x27;...</span><br><span class="line"></span><br><span class="line">Opened &#x27;Hello.dex&#x27;, DEX version &#x27;035&#x27;</span><br><span class="line"></span><br><span class="line">Class #0      -</span><br><span class="line"></span><br><span class="line"> Class descriptor : &#x27;LHello;&#x27;</span><br><span class="line"></span><br><span class="line"> Access flags   : 0x0001 (PUBLIC)</span><br><span class="line"></span><br><span class="line"> Superclass    : &#x27;Ljava/lang/Object;&#x27;</span><br><span class="line"></span><br><span class="line"> Interfaces    -</span><br><span class="line"></span><br><span class="line"> Static fields   -</span><br><span class="line"></span><br><span class="line"> Instance fields  -</span><br><span class="line"></span><br><span class="line"> Direct methods  -</span><br><span class="line"></span><br><span class="line">  \#0       : (in LHello;)</span><br><span class="line"></span><br><span class="line">   name     : &#x27;&lt;init&gt;&#x27;</span><br><span class="line"></span><br><span class="line">   type     : &#x27;()V&#x27;</span><br><span class="line"></span><br><span class="line">   access    : 0x10001 (PUBLIC CONSTRUCTOR)</span><br><span class="line"></span><br><span class="line">   code     -</span><br><span class="line"></span><br><span class="line">   registers   : 1</span><br><span class="line"></span><br><span class="line">   ins      : 1</span><br><span class="line"></span><br><span class="line">   outs     : 1</span><br><span class="line"></span><br><span class="line">   insns size  : 4 16-bit code units</span><br><span class="line"></span><br><span class="line">00014c:                    |[00014c] Hello.&lt;init&gt;:()V</span><br><span class="line"></span><br><span class="line">00015c: 7010 0400 0000             |0000: invoke-direct &#123;v0&#125;, Ljava/lang/Object;.&lt;init&gt;:()V // method@0004</span><br><span class="line"></span><br><span class="line">000162: 0e00                  |0003: return-void</span><br><span class="line"></span><br><span class="line">   catches    : (none)</span><br><span class="line"></span><br><span class="line">   positions   :</span><br><span class="line"></span><br><span class="line">​    0x0000 line=1</span><br><span class="line"></span><br><span class="line">   locals    :</span><br><span class="line"></span><br><span class="line">​    0x0000 - 0x0004 reg=0 this LHello;</span><br><span class="line"></span><br><span class="line">  \#1       : (in LHello;)</span><br><span class="line"></span><br><span class="line">   name     : &#x27;main&#x27;</span><br><span class="line"></span><br><span class="line">   type     : &#x27;([Ljava/lang/String;)V&#x27;</span><br><span class="line"></span><br><span class="line">   access    : 0x0009 (PUBLIC STATIC)</span><br><span class="line"></span><br><span class="line">   code     -</span><br><span class="line"></span><br><span class="line">   registers   : 5</span><br><span class="line"></span><br><span class="line">   ins      : 1</span><br><span class="line"></span><br><span class="line">   outs     : 3</span><br><span class="line"></span><br><span class="line">   insns size  : 17 16-bit code units</span><br><span class="line"></span><br><span class="line">000164:                    |[000164] Hello.main:([Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">000174: 2200 0100               |0000: new-instance v0, LHello; // type@0001</span><br><span class="line"></span><br><span class="line">000178: 7010 0000 0000             |0002: invoke-direct &#123;v0&#125;, LHello;.&lt;init&gt;:()V // method@0000</span><br><span class="line"></span><br><span class="line">00017e: 6201 0000               |0005: sget-object v1, Ljava/lang/System;.out:Ljava/io/PrintStream; // field@0000</span><br><span class="line"></span><br><span class="line">000182: 1252                  |0007: const/4 v2, #int 5 // #5</span><br><span class="line"></span><br><span class="line">000184: 1233                  |0008: const/4 v3, #int 3 // #3</span><br><span class="line"></span><br><span class="line">000186: 6e30 0100 2003             |0009: invoke-virtual &#123;v0, v2, v3&#125;, LHello;.foo:(II)I // method@0001</span><br><span class="line"></span><br><span class="line">00018c: 0a00                  |000c: move-result v0</span><br><span class="line"></span><br><span class="line">00018e: 6e20 0300 0100             |000d: invoke-virtual &#123;v1, v0&#125;, Ljava/io/PrintStream;.println:(I)V // method@0003</span><br><span class="line"></span><br><span class="line">000194: 0e00                  |0010: return-void</span><br><span class="line"></span><br><span class="line">   catches    : (none)</span><br><span class="line"></span><br><span class="line">   positions   :</span><br><span class="line"></span><br><span class="line">​    0x0000 line=7</span><br><span class="line"></span><br><span class="line">​    0x0005 line=8</span><br><span class="line"></span><br><span class="line">​    0x0010 line=9</span><br><span class="line"></span><br><span class="line">   locals    :</span><br><span class="line"></span><br><span class="line">​    0x0000 - 0x0011 reg=4 (null) [Ljava/lang/String;</span><br><span class="line"></span><br><span class="line"> **Virtual methods  -**</span><br><span class="line"></span><br><span class="line">  **#0       : (in LHello;)**</span><br><span class="line"></span><br><span class="line">   **name     : &#x27;foo&#x27;**</span><br><span class="line"></span><br><span class="line">   **type     : &#x27;(II)I&#x27;**</span><br><span class="line"></span><br><span class="line">   **access    : 0x0001 (PUBLIC)**</span><br><span class="line"></span><br><span class="line">   **code     -**</span><br><span class="line"></span><br><span class="line">   **registers   : 5**</span><br><span class="line"></span><br><span class="line">   **ins      : 3**</span><br><span class="line"></span><br><span class="line">   **outs     : 0**</span><br><span class="line"></span><br><span class="line">   **insns size  : 6 16-bit code units**</span><br><span class="line"></span><br><span class="line">**000198:                    |[000198] Hello.foo:(II)I**</span><br><span class="line"></span><br><span class="line">**//四条指令实现foo()，Dalvik虚拟机运行时涉及PC计数器、调用栈（维护寄存器列表）**</span><br><span class="line"></span><br><span class="line">**0001a8: 9000 0304               |0000: add-int v0, v3, v4**</span><br><span class="line"></span><br><span class="line">**0001ac: 9101 0304               |0002: sub-int v1, v3, v4**</span><br><span class="line"></span><br><span class="line">**0001b0: b210                  |0004: mul-int/2addr v0, v1**</span><br><span class="line"></span><br><span class="line">**0001b2: 0f00                  |0005: return v0**</span><br><span class="line"></span><br><span class="line">   **catches    : (none)**</span><br><span class="line"></span><br><span class="line">   **positions   :**</span><br><span class="line"></span><br><span class="line">​    **0x0000 line=3**</span><br><span class="line"></span><br><span class="line">   **locals    :**</span><br><span class="line"></span><br><span class="line">​    **0x0000 - 0x0006 reg=2 this LHello;**</span><br><span class="line"></span><br><span class="line">​    **0x0000 - 0x0006 reg=3 (null) I**</span><br><span class="line"></span><br><span class="line">​    **0x0000 - 0x0006 reg=4 (null) I**</span><br><span class="line"></span><br><span class="line"> source_file_idx  : 1 (Hello.java)</span><br></pre></td></tr></table></figure>

<h4 id="虚拟机执行流程"><a href="#虚拟机执行流程" class="headerlink" title="虚拟机执行流程"></a>虚拟机执行流程</h4><p>Android系统架构如下，<a target="_blank" rel="noopener" href="https://developer.android.com/guide/platform?hl=zh-cn">https://developer.android.com/guide/platform?hl=zh-cn</a></p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/2DF19C19-8A3A-4537-AFAF-3BBC14E9E031.png" alt="2DF19C19-8A3A-4537-AFAF-3BBC14E9E031"></p>
<p><strong>Android程序启动流程</strong></p>
<ol>
<li>Android系统启动并加载内核，执行init进程</li>
<li>init进程完成设备初始化，读取init.rc（run command）文件，启动Zygote进程（孵化进程）</li>
<li>Zygote启动，初始化Dalvik虚拟机，启动system_server进程（所有系统服务均由该进程启动），进入Zygote模式（有两种模式，一种是Zygote模式，初始化进程，一种是Application模式普通应用程序）</li>
</ol>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/543C0438-FE56-4ED9-BE98-9AEAD5645A41.png" alt="543C0438-FE56-4ED9-BE98-9AEAD5645A41"></p>
<ol>
<li>在完成如上的程序启动后，执行工作交给Dalvik虚拟机完成</li>
<li><ol>
<li>loadClassFromDex()函数装载类，每个类被解析成功后，获得运行时环境中ClassObject类型的数据结构存储</li>
<li>字节码验证器使用dvmVerifyCodeFlow()函数对装入对代码进行校验</li>
<li>FindClass()函数插座并装载main()方法类</li>
<li>调用dvmInterpret()函数初始化解释器并执行字节码流</li>
</ol>
</li>
</ol>
<p><strong>JIT：Just-in-time Compliation，即使编译（动态编译），运行时将字节码翻译为机器码，两种编译方式</strong></p>
<ul>
<li>method：以函数或方法为单位进行编译</li>
<li>trace：以trace为单位进行编译（代码执行路径有多条，执行很少的为<strong>冷路径</strong>，执行频繁的为<strong>热路径</strong>），快速获取热路径代码进行编译，Dalvik虚拟机默认的编译方式</li>
</ul>
<p><strong>Android构建过程</strong></p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/9D511DC3-3A12-4C89-9B7F-6F9FF4612D6E.png" alt="9D511DC3-3A12-4C89-9B7F-6F9FF4612D6E"></p>
<h3 id="静态分析Android程序"><a href="#静态分析Android程序" class="headerlink" title="静态分析Android程序"></a>静态分析Android程序</h3><p><strong>Frida安装与使用</strong></p>
<p>macOS端：pip3 install frida-tools</p>
<p>Android端：frida-server（选择相应架构版本arm64）</p>
<p>frida-server安装在/data/local/tmp目录，设置权限755，进程运行在端口27042</p>
<p>进行端口映射：./adb forward tcp:27042 tcp:27042</p>
<h3 id="Android开发小记"><a href="#Android开发小记" class="headerlink" title="Android开发小记"></a>Android开发小记</h3><p>如何从主活动跳到其他活动？</p>
<p>Intent消息传递对象，可以用于从其他组件请求操作。主要有如下用例：</p>
<ul>
<li>启动Activity</li>
<li>启动服务Service</li>
<li>传递广播</li>
</ul>
<p>Intent分为两种：显示Intent、隐式Intent</p>
<p>ACTION_START?</p>
<p>如下这里<strong>自定义category</strong>后，点击button1后程序崩溃</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.first_layout);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        findViewById()获取布局文件定义对元素，setOnClickListener()注册一个监听器</span></span><br><span class="line">        Button button1 = (Button) findViewById(R.id.button_1);</span><br><span class="line">        button1.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(<span class="string">&quot;android.intent.action.RUN&quot;</span>);</span><br><span class="line">                intent.addCategory(<span class="string">&quot;com.example.activitytest.MY_CATEGORY&quot;</span>);</span><br><span class="line"><span class="comment">//                构造Intent对象，使用startActivity()方法执行Intent</span></span><br><span class="line"><span class="comment">//                Intent intent = new Intent(FirstActivity.this, SecondActivity.class);</span></span><br><span class="line">                startActivity(intent);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//                finish();</span></span><br><span class="line"><span class="comment">//                Toast.makeText(FirstActivity.this, &quot;You clicked Button 1&quot;, Toast.LENGTH_LONG).show();</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>查看logcat，error信息如下，提示没有响应该Intent的Activity，在<intent-filter>中添加声明即可</intent-filter></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">2022-01-22 23:56:12.791 30463-30463/com.example.firstandroid3 E/AndroidRuntime: FATAL EXCEPTION: main</span><br><span class="line"><span class="code">    Process: com.example.firstandroid3, PID: 30463</span></span><br><span class="line"><span class="code">    android.content.ActivityNotFoundException: No Activity found to handle Intent &#123; act=android.intent.action.RUN cat=[com.example.activitytest.MY_CATEGORY] &#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>android:exported</p>
<p>其他应用的组件是否能调用服务或与之交互 —“<code>true</code>”表示可以，“<code>false</code>”表示不可以。当该值为“<code>false</code>”时，只有同一个应用或具有相同用户 ID 的应用的组件可以启动服务或绑定到服务。</p>
<p>默认值取决于服务是否包含 Intent 过滤器。没有任何过滤器意味着服务只能通过指定其确切的类名称进行调用。这意味着服务专供应用内部使用（因为其他应用不知晓其类名称）。因此，在这种情况下，默认值为“<code>false</code>”。另一方面，至少存在一个过滤器意味着服务专供外部使用，因此默认值为“<code>true</code>”。</p>
<p>此属性并非是唯一限制向其他应用披露服务的方式。您还可使用权限来限制哪些外部实体可以与服务交互（请参阅 <code>permission</code> 属性）。</p>
</blockquote>
<h4 id="活动的生命周期"><a href="#活动的生命周期" class="headerlink" title="活动的生命周期"></a>活动的生命周期</h4><p>Android使用Task来管理活动，Task是一组放置在栈里的活动的集合，又叫Back Stack。</p>
<p>活动状态</p>
<ul>
<li>运行态，处于栈顶</li>
<li>暂停状态，活动不处于栈顶位置，但仍然可见（并不是每一个活动都会占用屏幕中间的部分区域，例如对话框形式的活动）</li>
<li>停止状态，不处于栈顶，也不可见</li>
<li>销毁状态，活动从返回栈中移除</li>
</ul>
<p>活动的生存期</p>
<ul>
<li>onCreate()，活动的初始化操作</li>
<li>onStart()，活动由不可见变为可见</li>
<li>onResume()，恢复，活动准备好与用户进行交互的时候</li>
<li>onPause()，系统准备去启动或恢复另一个活动的时候调用</li>
<li>onStop()，活动完全不可见时候调用</li>
<li>onDestroy()，方法在活动被销毁之前调用，之后活动的状态变为销毁状态</li>
<li>onRestart()，活动被重新启动时调用</li>
</ul>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/activity_lifecycle.png" alt="img"></p>
<h4 id="Android布局"><a href="#Android布局" class="headerlink" title="Android布局"></a>Android布局</h4><p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220128112100992.png" alt="image-20220128112100992"></p>
<p><font color="red">layout_gravity、gravity？</font></p>
<p><font color="red">LayoutInflater对象，inflate()方法</font></p>
<p>布局分类：</p>
<ul>
<li>LinearLayout，线性布局</li>
<li>RelativeLayout，相对布局，相对于布局和空间进行定位</li>
<li>FrameLayout，帧布局</li>
<li>百分比布局<ul>
<li>PercentRelativeLayout</li>
<li>PercentFrameLayout</li>
</ul>
</li>
</ul>
<p><strong>常用控件和布局的继承结构</strong></p>
<p><img src="/2022/01/18/Android%E9%80%86%E5%90%91%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0/image-20220128121435652.png" alt="image-20220128121435652"></p>
<p>可以引入布局</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/%E9%80%86%E5%90%91/" rel="tag"># 逆向</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/12/15/%E7%81%B0%E8%A2%8D%E6%8E%A8%E9%80%81Mark/" rel="prev" title="灰袍推送Mark">
                  <i class="fa fa-chevron-left"></i> 灰袍推送Mark
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/01/%E3%80%8A%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%BA%94%E7%94%A8%E3%80%8B%E7%AC%94%E8%AE%B0/" rel="next" title="《区块链技术与应用》笔记">
                  《区块链技术与应用》笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81NjQzNi8zMjg5OQ=="></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">尘埃落定</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js","integrity":"sha256-7wT34TI0pEBeEFoi4z+vhuSddGh6vUTMWdqJ2SDe2jg="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  




<script src="/js/third-party/comments/livere.js"></script>

</body>
</html>
